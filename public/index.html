<html>

<title>AOR AR-DV1 Receiver control</title>

<head>
  <script src="js/socket.io-client.min.js"></script>
  <script src="http://code.jquery.com/jquery-latest.js"></script>

  <script type="text/javascript">
    var socket = io.connect();

    socket.on('connected', function(data) {
      console.log('Connected, this is what I received : ');
    });

    // when you get a receiveSerial event, do this
    socket.on('receiveSerial', function(data) {
      console.log(data);

      $("#serialDisplay").val(data);

      //Split out RF data
      if (data.indexOf("RF") >= 0) {
        freq = data.substring(data.indexOf("RF") + 2);
        $("#frequency").val(freq.split(" ")[0]);
      };

      //Split out Level and Mute data
      if (data.indexOf("LM") >= 0) {
        levelData = data.substring(data.indexOf("LM") + 2);
        level = levelData.substring(0, 3);
        mute = levelData.substring(3, 4);
        $("#level").val(level.split(" ")[0] * -1);
      }

      //Split out and determine receiver mode
      if (data.indexOf("MD") >= 0) {
        modeData = data.substring(data.indexOf("MD") + 2);
        modeCode = modeData.split(" ")[0];

        $("#mode").val(modeCode.split(" ")[0]);
      }

      //Split out step rate
      if (data.indexOf("ST") >= 0) {
        step = data.substring(data.indexOf("ST") + 2);
        $("#step").val(step.split(" ")[0]);
      }


    });
  </script>


  <body>

    <h2>AOR AR-DV1 Control</h2>
    <form>
      <div>

        <label for="frequency">Frequency (MHz):</label>
        <input type="number" id="frequency" value="Waiting.." />
        <input id="up" type="submit" value="UP" />
        <input id="down" type="submit" value="DOWN" />
      </div>
      <div>

        <label for="level">Level:</label>
        <input disabled="disabled" id="level" value="Waiting.." />
      </div>
      <div>
        <label for="step">Step (kHz):</label>
        <input type="number" id="step" value="Waiting.." />
      </div>
      <div>
        <label for="mode">Mode:</label>
        <select id="mode">
          <option value="000">Auto</option>
          <option value="0F1">AM</option>
          <option value="0F0">FM</option>
          <option value="0F4">USB</option>
          <option value="0F5">LSB</option>
          <option value="0F6">CW</option>
          <option value="110">D-Star</option>
          <option value="440">NXDN</option>
          <option value="550">P25</option>
          <option value="770">DMR</option>
        </select>
      </div>

      <script>
        $("#frequency").keypress(function(event) {
          if (event.which == 13) {
            event.preventDefault();
            var inputFreq = document.getElementById('frequency').value;
            var newFreq = parseFloat(inputFreq).toFixed(5);
            var inputCommand = "RF" + newFreq;
            console.log("sending: " + inputCommand)
            socket.emit("sendSerial", inputCommand);
            socket.emit("sendSerial", "RX");
            $("#frequency").submit();
          }
        });

        $("#step").keypress(function(event) {
          if (event.which == 13) {
            event.preventDefault();
            var inputStep = document.getElementById('step').value;
            var newStep = parseFloat(inputStep).toFixed(2);
            var inputCommand = "ST" + newStep;
            console.log("sending: " + inputCommand)
            socket.emit("sendSerial", inputCommand);
            socket.emit("sendSerial", "RX");
            $("#step").submit();
          }
        });

        $("#mode").change(function(event) {
          event.preventDefault();
          var inputMode = document.getElementById('mode').value;
          var inputCommand = "MD" + inputMode;
          console.log("sending: " + inputCommand)
          socket.emit("sendSerial", inputCommand);
          socket.emit("sendSerial", "RX");
        });

        $("#up").click(function(event) {
          event.preventDefault();
          var inputFreq = document.getElementById('frequency').value;
          var inputStep = document.getElementById('step').value;
          var newStep = parseFloat(inputStep).toFixed(2);
          var newFreq = parseFloat(parseFloat(inputFreq) + parseFloat(newStep * 0.001)).toFixed(5);
          console.log("New freq: " + newFreq);
          var inputCommand = "RF" + newFreq;
          socket.emit("sendSerial", inputCommand);
          socket.emit("sendSerial", "RX");
        });

        $("#down").click(function(event) {
          event.preventDefault();
          var inputFreq = document.getElementById('frequency').value;
          var inputStep = document.getElementById('step').value;
          var newStep = parseFloat(inputStep).toFixed(2);
          var newFreq = parseFloat(parseFloat(inputFreq) - parseFloat(newStep * 0.001)).toFixed(5);
          console.log("New freq: " + newFreq);
          var inputCommand = "RF" + newFreq;
          socket.emit("sendSerial", inputCommand);
          socket.emit("sendSerial", "RX");
        });
      </script>

      <link rel="stylesheet" href="style.css" />

</head>

</body>

</html>
